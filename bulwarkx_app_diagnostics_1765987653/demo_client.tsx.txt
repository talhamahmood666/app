"use client";

import { useEffect, useMemo, useState } from "react";
import { ConnectButton } from "@rainbow-me/rainbowkit";
import {
  useAccount,
  useReadContract,
  useWriteContract,
  useWaitForTransactionReceipt,
} from "wagmi";
import { parseEther, isAddress, formatEther, decodeEventLog } from "viem";

import ABI from "@/contracts/BulwarkXEscrow.abi.json";
import { ESCROW_ADDRESSES } from "@/contracts/addresses";

type Hex = `0x${string}`;

function cx(...classes: Array<string | false | undefined | null>) {
  return classes.filter(Boolean).join(" ");
}

function explorerBase(): string {
  return process.env.NEXT_PUBLIC_BASESCAN_BASE || "https://sepolia.basescan.org";
}

function linkTx(hash?: Hex | null) {
  if (!hash) return null;
  return `${explorerBase()}/tx/${hash}`;
}
function linkAddr(addr?: Hex | null) {
  if (!addr) return null;
  return `${explorerBase()}/address/${addr}`;
}

function prettyError(err: unknown): string {
  const msg = String((err as any)?.shortMessage || (err as any)?.message || err || "");
  return msg.replaceAll("ContractFunctionExecutionError:", "").trim();
}

function nowUnix(): number {
  return Math.floor(Date.now() / 1000);
}

export default function DemoClient() {
  const { address, isConnected } = useAccount();

  const contractAddress = ESCROW_ADDRESSES.baseSepolia as Hex;

  // ----- Create escrow form -----
  const [payee, setPayee] = useState<string>("");
  const [arbiter, setArbiter] = useState<string>("");
  const [amountEth, setAmountEth] = useState<string>("0.001");
  const [autoReleaseMins, setAutoReleaseMins] = useState<string>("60");

  const releaseTime = useMemo(() => {
    const mins = Number(autoReleaseMins || "0");
    const clamped = Number.isFinite(mins) ? Math.max(0, mins) : 0;
    return nowUnix() + clamped * 60;
  }, [autoReleaseMins]);

  // ----- Escrow ID input / state -----
  const [escrowId, setEscrowId] = useState<string>("");
  const escrowIdHex = (escrowId || "").trim() as Hex;

  const escrowIdLooksValid =
    escrowIdHex.startsWith("0x") &&
    escrowIdHex.length === 66; // bytes32 = 32 bytes = 64 hex chars + 0x

  // Read escrow struct via public mapping getter: escrows(bytes32)
  const escrowRead = useReadContract({
    address: contractAddress,
    abi: ABI as any,
    functionName: "escrows",
    args: escrowIdLooksValid ? [escrowIdHex] : undefined,
    query: {
      enabled: escrowIdLooksValid,
      refetchInterval: 4000, // grant demo feel: "live"
    },
  });

  // ----- Write hooks -----
  const { writeContractAsync } = useWriteContract();

  const [lastTx, setLastTx] = useState<Hex | null>(null);
  const [statusMsg, setStatusMsg] = useState<string>("");
  const [errorMsg, setErrorMsg] = useState<string>("");

  const receipt = useWaitForTransactionReceipt({
    hash: lastTx || undefined,
  });

  // When tx completes, try to pull escrowId from event logs (if event exists in ABI)
  useEffect(() => {
    if (!receipt.data || !receipt.isSuccess) return;

    // If user already has escrowId, don’t override it
    if (escrowIdLooksValid) return;

    try {
      const logs = receipt.data.logs || [];
      for (const log of logs) {
        try {
          const decoded = decodeEventLog({
            abi: ABI as any,
            data: log.data,
            topics: log.topics,
          });

          // Heuristic: if any event arg is bytes32, take it
          const args = decoded?.args as Record<string, any> | undefined;
          if (args) {
            for (const key of Object.keys(args)) {
              const v = args[key];
              if (typeof v === "string" && v.startsWith("0x") && v.length === 66) {
                setEscrowId(v);
                setStatusMsg(`Escrow ID detected from tx log ✅`);
                return;
              }
            }
          }
        } catch {
          // ignore non-matching logs
        }
      }

      setStatusMsg(
        `Tx confirmed ✅ (If escrowId didn't auto-fill, copy it from the tx logs on BaseScan.)`
      );
    } catch {
      setStatusMsg(`Tx confirmed ✅`);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [receipt.isSuccess, receipt.data]);

  // ----- Derived escrow display -----
  const escrow = escrowRead.data as any;

  const escrowExists = useMemo(() => {
    // We don’t know the exact struct fields, so we do a robust check:
    // If it returns something and at least one address-like field is non-zero, assume it exists.
    if (!escrow) return false;
    const vals = Array.isArray(escrow) ? escrow : Object.values(escrow);
    const addrLike = vals.find(
      (v) => typeof v === "string" && v.startsWith("0x") && v.length === 42
    );
    return Boolean(addrLike && addrLike !== "0x0000000000000000000000000000000000000000");
  }, [escrow]);

  // Buttons should only enable when connected and escrowId valid
  const canAct = isConnected && escrowIdLooksValid;

  // ----- Actions -----
  async function handleCreateEscrow() {
    setErrorMsg("");
    setStatusMsg("");

    const payeeOk = isAddress(payee);
    const arbiterOk = isAddress(arbiter);
    if (!payeeOk) return setErrorMsg("Payee address is invalid.");
    if (!arbiterOk) return setErrorMsg("Arbiter address is invalid.");

    let value: bigint;
    try {
      value = parseEther(amountEth || "0");
      if (value <= 0n) return setErrorMsg("Amount must be > 0.");
    } catch {
      return setErrorMsg("Amount is invalid. Example: 0.01");
    }

    try {
      setStatusMsg("Submitting create escrow transaction…");
      const hash = await writeContractAsync({
        address: contractAddress,
        abi: ABI as any,
        // IMPORTANT: overloaded function support by full signature:
        functionName: "createEscrow(address,address,uint256)" as any,
        args: [payee as Hex, arbiter as Hex, BigInt(releaseTime)],
        value,
      });

      setLastTx(hash as Hex);
      setStatusMsg("Transaction submitted. Waiting for confirmation…");
    } catch (e) {
      setErrorMsg(prettyError(e));
      setStatusMsg("");
    }
  }

  async function handleRelease() {
    setErrorMsg("");
    setStatusMsg("");
    try {
      setStatusMsg("Submitting release…");
      const hash = await writeContractAsync({
        address: contractAddress,
        abi: ABI as any,
        functionName: "releaseEscrow(bytes32)" as any,
        args: [escrowIdHex],
      });
      setLastTx(hash as Hex);
      setStatusMsg("Release tx submitted. Waiting for confirmation…");
    } catch (e) {
      setErrorMsg(prettyError(e));
    }
  }

  async function handleRefund() {
    setErrorMsg("");
    setStatusMsg("");
    try {
      setStatusMsg("Submitting refund…");
      const hash = await writeContractAsync({
        address: contractAddress,
        abi: ABI as any,
        functionName: "refundEscrow(bytes32)" as any,
        args: [escrowIdHex],
      });
      setLastTx(hash as Hex);
      setStatusMsg("Refund tx submitted. Waiting for confirmation…");
    } catch (e) {
      setErrorMsg(prettyError(e));
    }
  }

  async function handleDispute() {
    setErrorMsg("");
    setStatusMsg("");
    try {
      setStatusMsg("Opening dispute…");
      const hash = await writeContractAsync({
        address: contractAddress,
        abi: ABI as any,
        functionName: "openDispute(bytes32)" as any,
        args: [escrowIdHex],
      });
      setLastTx(hash as Hex);
      setStatusMsg("Dispute tx submitted. Waiting for confirmation…");
    } catch (e) {
      setErrorMsg(prettyError(e));
    }
  }

  const pending =
    receipt.isLoading ||
    receipt.isFetching ||
    statusMsg.toLowerCase().includes("waiting") ||
    statusMsg.toLowerCase().includes("submitting");

  return (
    <div className="mx-auto max-w-6xl px-4 py-10">
      {/* Header */}
      <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-2xl font-semibold tracking-tight">BulwarkX Demo</h1>
          <p className="mt-1 text-sm text-white/70">
            Non-custodial escrow on Base Sepolia. Create escrow, then release/refund/dispute with full
            on-chain proof.
          </p>
        </div>
        <div className="rounded-xl border border-white/10 bg-white/5 p-2">
          <ConnectButton />
        </div>
      </div>

      {/* Main grid */}
      <div className="mt-8 grid gap-6 lg:grid-cols-2">
        {/* Left: Create escrow */}
        <section className="rounded-2xl border border-white/10 bg-white/5 p-5 shadow-lg">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-medium">1) Create escrow (Native ETH)</h2>
            <a
              className="text-xs text-white/60 underline underline-offset-4 hover:text-white"
              href={linkAddr(contractAddress) || "#"}
              target="_blank"
              rel="noreferrer"
            >
              Contract on BaseScan
            </a>
          </div>

          <div className="mt-4 grid gap-4">
            <Field
              label="Payee address"
              value={payee}
              onChange={setPayee}
              placeholder="0x…"
              hint="Recipient who gets paid on release."
            />
            <Field
              label="Arbiter address"
              value={arbiter}
              onChange={setArbiter}
              placeholder="0x…"
              hint="Can resolve disputes (if your contract enables)."
            />

            <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
              <Field
                label="Amount (ETH)"
                value={amountEth}
                onChange={setAmountEth}
                placeholder="0.001"
                hint="Sent as msg.value"
              />
              <Field
                label="Auto-release (minutes from now)"
                value={autoReleaseMins}
                onChange={setAutoReleaseMins}
                placeholder="60"
                hint={`Unix time: ${releaseTime}`}
              />
            </div>

            <button
              onClick={handleCreateEscrow}
              disabled={!isConnected || pending}
              className={cx(
                "mt-2 w-full rounded-xl px-4 py-3 text-sm font-medium transition",
                !isConnected || pending
                  ? "cursor-not-allowed bg-white/10 text-white/40"
                  : "bg-white text-black hover:bg-white/90"
              )}
            >
              {pending ? "Working…" : "Create Escrow"}
            </button>

            <div className="mt-3 rounded-xl border border-white/10 bg-black/40 p-3 text-xs text-white/70">
              <div className="flex flex-col gap-2">
                <Row label="Connected" value={isConnected ? "Yes" : "No"} />
                <Row label="Wallet" value={address ? shortAddr(address) : "—"} />
                <Row
                  label="Last tx"
                  value={
                    lastTx ? (
                      <a
                        className="underline underline-offset-4 hover:text-white"
                        href={linkTx(lastTx) || "#"}
                        target="_blank"
                        rel="noreferrer"
                      >
                        {shortAddr(lastTx)}
                      </a>
                    ) : (
                      "—"
                    )
                  }
                />
                <Row
                  label="Receipt"
                  value={
                    receipt.isSuccess
                      ? "Confirmed ✅"
                      : receipt.isError
                      ? "Failed ❌"
                      : lastTx
                      ? "Pending…"
                      : "—"
                  }
                />
              </div>
